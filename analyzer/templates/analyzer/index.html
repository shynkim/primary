{% extends 'analyzer/base.html' %}

{% block title %}APK × 처리방침 비교 분석 — 업로드{% endblock %}

{% block content %}
<div class="container-xxl py-4">

  <!-- Hero / Steps -->
  <div class="card shadow-sm border-0 mb-4 hero-surface">
    <div class="card-body p-4">
      <h5 class="fw-bold mb-2">시작하기</h5>
      <p class="text-muted mb-3">
        앱의 APK 파일과 개인정보 처리방침 문서를 업로드하면, 두 문서 간의 일치 여부를 자동으로 검증하고 개선 방안을 제안해드립니다.
      </p>
      <div class="d-flex flex-wrap gap-4">
        <div class="d-flex align-items-center gap-2 step">
          <span class="step-num">1</span>
          <div>
            <div class="fw-semibold">APK 파일 업로드</div>
            <div class="text-muted small">앱의 권한 정보를 추출합니다</div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2 step">
          <span class="step-num">2</span>
          <div>
            <div class="fw-semibold">처리방침 업로드</div>
            <div class="text-muted small">개인정보 수집 항목을 분석합니다</div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2 step">
          <span class="step-num">3</span>
          <div>
            <div class="fw-semibold">비교 및 분석</div>
            <div class="text-muted small">일치 여부와 개선사항 확인</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload form -->
  <form method="post" action="{% url 'analyzer:upload_apk' %}" enctype="multipart/form-data" id="uploadForm">
    {% csrf_token %}

    <div class="row g-4">
      <!-- APK -->
      <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body p-4">
            <div class="d-flex align-items-center gap-2 mb-3">
              <div class="avatar bg-success-subtle text-success-emphasis"><i class="fa-solid fa-cube"></i></div>
              <div>
                <div class="fw-semibold">APK 파일</div>
                <div class="text-muted small">Android 앱 패키지 파일</div>
              </div>
            </div>

            <div id="apkDrop"
                 class="dropzone"
                 tabindex="0"
                 role="button"
                 aria-label="APK 업로드 영역 (파일 선택 또는 드래그 앤 드롭)">
              <div class="text-center">
                <i class="fa-solid fa-upload fa-2x mb-2 text-primary"></i>
                <div class="fw-semibold">파일 선택 또는 드래그 앤 드롭</div>
                <div class="text-muted small">APK 파일만 지원됩니다</div>
              </div>
              <input id="apkFile" name="apk_file" type="file" accept=".apk" class="d-none" required>
            </div>

            <div id="apkChip" class="mt-3 d-none"></div>
          </div>
        </div>
      </div>

      <!-- Policy -->
      <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body p-4">
            <div class="d-flex align-items-center gap-2 mb-3">
              <div class="avatar bg-purple-subtle text-purple"><i class="fa-solid fa-file-lines"></i></div>
              <div>
                <div class="fw-semibold">개인정보 처리방침</div>
                <div class="text-muted small">PDF, DOC, TXT 형식</div>
              </div>
            </div>

            <div id="policyDrop"
                 class="dropzone"
                 tabindex="0"
                 role="button"
                 aria-label="처리방침 업로드 영역 (파일 선택 또는 드래그 앤 드롭)">
              <div class="text-center">
                <i class="fa-solid fa-upload fa-2x mb-2 text-primary"></i>
                <div class="fw-semibold">파일 선택 또는 드래그 앤 드롭</div>
                <div class="text-muted small">PDF, DOC, DOCX, TXT 파일 지원</div>
              </div>
              <input id="policyFile" name="policy_file" type="file" accept=".pdf,.doc,.docx,.txt" class="d-none" required>
            </div>

            <div id="policyChip" class="mt-3 d-none"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CTA -->
    <div class="text-center my-4">
      <button id="uploadBtn" type="submit" class="btn btn-primary btn-lg px-4" disabled>
        분석 시작
      </button>
      <div class="text-muted small mt-2">최대 50MB / 파일</div>
    </div>
  </form>

</div>
{% endblock %}

{% block extra_css %}
<style>
  /* 배경과 카드 톤을 캡처 느낌으로 */
  body { background: radial-gradient(900px 500px at 10% -10%, #e9eeff 0%, transparent 60%),
                    radial-gradient(900px 500px at 110% -10%, #e9ffee 0%, transparent 60%),
                    #f6f9ff; }
  .hero-surface { border:1px solid #e6e9f4; }
  .step .step-num{
    width:28px;height:28px;border-radius:999px;
    display:grid;place-items:center;
    color:#fff;background:#6a8dff;font-weight:700;
  }
  .avatar{
    width:36px;height:36px;border-radius:10px;display:grid;place-items:center;font-size:16px;
  }
  .bg-purple-subtle{ background:#f2e8ff; }
  .text-purple{ color:#7c3aed; }

  .dropzone{
    border:2px dashed #c7d2fe;
    border-radius:14px;
    background:#fafbff;
    padding:28px;
    min-height:160px;
    display:flex;align-items:center;justify-content:center;
    transition: all .15s ease;
    outline: none;
  }
  .dropzone.dragover{ background:#eef2ff; border-color:#6a8dff; }
  .file-chip{
    display:inline-flex;align-items:center;gap:.5rem;
    border:1px solid #dee6ff;background:#eef2ff;color:#334155;
    padding:.4rem .6rem;border-radius:999px;font-size:.85rem;max-width:100%;
  }
  .file-chip small{ opacity:.7; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const MAX = 50 * 1024 * 1024; // 50MB

  const apkDrop   = document.getElementById('apkDrop');
  const policyDrop= document.getElementById('policyDrop');
  const apkInput  = document.getElementById('apkFile');
  const polInput  = document.getElementById('policyFile');
  const apkChip   = document.getElementById('apkChip');
  const polChip   = document.getElementById('policyChip');
  const btn       = document.getElementById('uploadBtn');
  const form      = document.getElementById('uploadForm');

  function human(n){
    if(n===0) return '0 B';
    const k=1024, u=['B','KB','MB','GB']; const i=Math.floor(Math.log(n)/Math.log(k));
    return (n/Math.pow(k,i)).toFixed(2)+' '+u[i];
  }
  function setChip(el, file){
    el.innerHTML = `
      <span class="file-chip">
        <i class="fa-regular fa-file-lines"></i>
        <span class="text-truncate">${file.name}</span>
        <small>· ${human(file.size)}</small>
      </span>`;
    el.classList.remove('d-none');
  }
  function enableIfReady(){
    btn.disabled = !(apkInput.files?.length && polInput.files?.length);
  }
  function over(e){ e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.add('dragover'); }
  function leave(e){ e.preventDefault(); e.stopPropagation(); e.currentTarget.classList.remove('dragover'); }
  function dropTo(input, chip, exts){
    return (e)=>{
      e.preventDefault(); e.currentTarget.classList.remove('dragover');
      const f = e.dataTransfer.files?.[0]; if(!f) return;
      const ok = exts.some(ext => f.name.toLowerCase().endsWith(ext));
      if(!ok){ alert(exts.join(', ')+' 파일만 업로드 가능합니다.'); return; }
      if(f.size > MAX){ alert('파일 크기는 50MB를 초과할 수 없습니다.'); return; }
      // 파일 주입
      input.files = e.dataTransfer.files;
      setChip(chip, f); enableIfReady();
    }
  }
  function choose(input, chip, exts){
    return (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const ok = exts.some(ext => f.name.toLowerCase().endsWith(ext));
      if(!ok){ alert(exts.join(', ')+' 파일만 업로드 가능합니다.'); input.value=''; return; }
      if(f.size > MAX){ alert('파일 크기는 50MB를 초과할 수 없습니다.'); input.value=''; return; }
      setChip(chip, f); enableIfReady();
    }
  }
  function clickOpen(input){ input.click(); }
  function keyOpen(input){ return (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); input.click(); } }; }

  // APK 바인딩
  ['dragenter','dragover'].forEach(ev => apkDrop.addEventListener(ev, over));
  ['dragleave','drop'].forEach(ev => apkDrop.addEventListener(ev, leave));
  apkDrop.addEventListener('drop', dropTo(apkInput, apkChip, ['.apk']));
  apkDrop.addEventListener('click', ()=>clickOpen(apkInput));
  apkDrop.addEventListener('keydown', keyOpen(apkInput));
  apkInput.addEventListener('change', choose(apkInput, apkChip, ['.apk']));

  // Policy 바인딩
  ['dragenter','dragover'].forEach(ev => policyDrop.addEventListener(ev, over));
  ['dragleave','drop'].forEach(ev => policyDrop.addEventListener(ev, leave));
  policyDrop.addEventListener('drop', dropTo(polInput, polChip, ['.pdf','.doc','.docx','.txt']));
  policyDrop.addEventListener('click', ()=>clickOpen(polInput));
  policyDrop.addEventListener('keydown', keyOpen(polInput));
  polInput.addEventListener('change', choose(polInput, polChip, ['.pdf','.doc','.docx','.txt']));

  // 제출 로딩
  form.addEventListener('submit', ()=>{
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>분석 중...';
    btn.disabled = true;
  });
});
</script>
{% endblock %}
