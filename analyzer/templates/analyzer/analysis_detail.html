{% extends 'analyzer/base.html' %}
{% block title %}{{ analysis.file_name }} - 개인정보 항목 비교 결과{% endblock %}

{% block content %}
<div class="container-xxl py-4">

  <!-- SECTION 1: APK 내부 권한 라벨링 -->
  <div class="mb-5">
    <h4 class="fw-bold mb-1">📱 APK 권한 기반 개인정보 항목</h4>
    <p class="text-muted mb-4">앱이 실제로 접근 가능한 개인정보 항목입니다.</p>

    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body p-4">
        {% if analysis.permissions %}
          <div class="mb-3"><strong>총 {{ analysis.permissions|length }}개 권한 감지됨</strong></div>
          <div class="d-flex flex-wrap gap-2">
            {% for p in analysis.permissions %}
              <span class="badge bg-primary-subtle text-primary">{{ p }}</span>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">감지된 권한이 없습니다.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- SECTION 2: 처리방침 텍스트 라벨링 -->
  <div class="mb-5">
    <h4 class="fw-bold mb-1">📄 처리방침 기반 개인정보 항목</h4>
    <p class="text-muted mb-4">AI 모델이 처리방침 텍스트를 분석하여 인식한 개인정보 항목입니다.</p>

    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body p-4">
        {% if analysis.policy_labels %}
          <div class="mb-3"><strong>총 {{ analysis.policy_labels|length }}개 항목 인식됨</strong></div>
          <div class="d-flex flex-wrap gap-2">
            {% for label in analysis.policy_labels %}
              <span class="badge bg-secondary-subtle text-secondary">{{ label }}</span>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">처리방침에서 인식된 개인정보 항목이 없습니다.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- SECTION 3: 비교 결과 -->
  <div class="mb-5">
    <h4 class="fw-bold mb-1">🔍 비교 결과 (APK vs 처리방침)</h4>
    <p class="text-muted mb-4">앱이 실제로 접근하는 항목과 처리방침에 명시된 항목 간의 일치도를 분석합니다.</p>

    {% with comp=analysis.comparison %}
    <div class="card border-0 shadow-sm rounded-4 mb-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            전체 일치도
            <small class="text-muted">
              ({{ comp.totals.matched }}개 일치 / {{ comp.totals.total }}개 항목 중)
            </small>
          </div>
          <h3 class="fw-bold text-warning mb-0">{{ comp.totals.percentage }}%</h3>
        </div>
        <div class="progress bg-light" style="height:10px;">
          <div class="progress-bar bg-warning" style="width: {{ comp.totals.percentage }}%"></div>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="stat-box bg-success-subtle text-success">
          <div class="h4 mb-0">{{ comp.totals.matched }}</div>
          <small>일치 항목</small>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-box bg-danger-subtle text-danger">
          <div class="h4 mb-0">{{ comp.only_perm|length }}</div>
          <small>앱에는 있으나 처리방침에 없음</small>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-box bg-warning-subtle text-warning">
          <div class="h4 mb-0">{{ comp.only_policy|length }}</div>
          <small>처리방침에는 있으나 앱에는 없음</small>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <!-- 일치 항목 -->
      <div class="col-lg-4">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h6 class="text-success mb-3"><i class="fa-regular fa-circle-check me-2"></i>일치 항목</h6>
            {% for l in comp.matched %}
              <div class="match-item bg-success-subtle text-success p-2 rounded-3 mb-1 small">{{ l }}</div>
            {% empty %}<p class="text-muted small">일치 항목 없음</p>{% endfor %}
          </div>
        </div>
      </div>

      <!-- 앱에는 있으나 처리방침에 없음 -->
      <div class="col-lg-4">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h6 class="text-danger mb-3"><i class="fa-regular fa-circle-xmark me-2"></i>앱에만 존재 (미고지)</h6>
            {% for l in comp.only_perm %}
              <div class="match-item bg-danger-subtle text-danger p-2 rounded-3 mb-1 small">{{ l }}</div>
            {% empty %}<p class="text-muted small">없음</p>{% endfor %}
          </div>
        </div>
      </div>

      <!-- 처리방침에는 있으나 앱에 없음 -->
      <div class="col-lg-4">
        <div class="card border-0 shadow-sm rounded-4">
          <div class="card-body">
            <h6 class="text-warning mb-3"><i class="fa-regular fa-circle-exclamation me-2"></i>처리방침에만 존재 (불필요 명시)</h6>
            {% for l in comp.only_policy %}
              <div class="match-item bg-warning-subtle text-warning p-2 rounded-3 mb-1 small">{{ l }}</div>
            {% empty %}<p class="text-muted small">없음</p>{% endfor %}
          </div>
        </div>
      </div>
    </div>
    {% endwith %}
  </div>

  <div class="text-center mt-5">
    <a href="{% url 'analyzer:index' %}" class="btn btn-outline-secondary btn-lg px-4">새로운 분석 시작하기</a>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  body {
    background:
      radial-gradient(900px 500px at 12% 2%, #e9eeff 0%, transparent 60%),
      radial-gradient(900px 500px at 88% 2%, #e9ffee 0%, transparent 60%),
      #f8faff;
  }

  .bg-success-subtle { background: #eaf8ef !important; }
  .bg-danger-subtle  { background: #fdecec !important; }
  .bg-warning-subtle { background: #fff4e5 !important; }
  .bg-primary-subtle { background: #eef2ff !important; }
  .bg-secondary-subtle { background: #f3f4f6 !important; }

  .text-success { color: #16a34a !important; }
  .text-danger  { color: #ef4444 !important; }
  .text-warning { color: #f59e0b !important; }
  .text-primary { color: #3b82f6 !important; }
  .text-secondary { color: #64748b !important; }

  .stat-box {
    border-radius: 1rem;
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    border: 1px solid #e5e7eb;
  }

  .match-item {
    border: 1px solid #e5e7eb;
  }
</style>
{% endblock %}
